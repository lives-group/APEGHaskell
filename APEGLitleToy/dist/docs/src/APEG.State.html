<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span>
</span><a name="line-2"></a><span class="hs-comment">{-|
Module      : APEG.State
Description : Representation of a state for the APEG interpreter/type-checker
Copyright   : (c) Leonardo Vieira dos Santos Reis, 2018
                  Rodrigo Geraldo Ribeiro, 2018
                  Elton M. Cardoso, 2018
License     : GPL-3
Stability   : experimental
Portability : POSIX

This module contains the definition of an APEG state used throughout the interpreter and type-checker.
The abstract data type allows for consulting and updating value and type environments, obtain the
string currently accepted by the recognizer, setting and consulting and transforming the results and
finally manipulation of the input.

-}</span><span>
</span><a name="line-18"></a><span>
</span><a name="line-19"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">APEG.State</span><span class="hs-special">(</span><span>
</span><a name="line-20"></a><span>    </span><a href="APEG.State.html#APegTuple"><span class="hs-identifier hs-type">APegTuple</span></a><span class="hs-special">,</span><span>
</span><a name="line-21"></a><span>    </span><a href="APEG.State.html#Result"><span class="hs-identifier hs-type">Result</span></a><span class="hs-special">,</span><span>
</span><a name="line-22"></a><span>    </span><a href="APEG.State.html#APegSt"><span class="hs-identifier hs-type">APegSt</span></a><span class="hs-special">,</span><span>
</span><a name="line-23"></a><span>    </span><a href="APEG.State.html#VEnv"><span class="hs-identifier hs-type">VEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-24"></a><span>    </span><a href="APEG.State.html#TyEnv"><span class="hs-identifier hs-type">TyEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-25"></a><span>    </span><a href="APEG.State.html#TyRuleEnv"><span class="hs-identifier hs-type">TyRuleEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-26"></a><span>    </span><a href="APEG.State.html#TraceStr"><span class="hs-identifier hs-type">TraceStr</span></a><span class="hs-special">,</span><span>
</span><a name="line-27"></a><span>    </span><a href="APEG.State.html#Input"><span class="hs-identifier hs-type">Input</span></a><span class="hs-special">,</span><span>
</span><a name="line-28"></a><span>    </span><a href="APEG.State.html#rVal"><span class="hs-identifier hs-var">rVal</span></a><span class="hs-special">,</span><span>
</span><a name="line-29"></a><span>    </span><a href="APEG.State.html#rErr"><span class="hs-identifier hs-var">rErr</span></a><span class="hs-special">,</span><span>
</span><a name="line-30"></a><span>    </span><span class="hs-special">(</span><a href="APEG.State.html#%3F%3A"><span class="hs-operator hs-var">?:</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-31"></a><span>    </span><a href="APEG.State.html#nullTraceStr"><span class="hs-identifier hs-var">nullTraceStr</span></a><span class="hs-special">,</span><span>
</span><a name="line-32"></a><span>    </span><a href="APEG.State.html#emptyTraceStr"><span class="hs-identifier hs-var">emptyTraceStr</span></a><span class="hs-special">,</span><span>
</span><a name="line-33"></a><span>    </span><a href="APEG.State.html#errorTuple"><span class="hs-identifier hs-var">errorTuple</span></a><span class="hs-special">,</span><span>
</span><a name="line-34"></a><span>    </span><a href="APEG.State.html#isOkTuple"><span class="hs-identifier hs-var">isOkTuple</span></a><span class="hs-special">,</span><span>
</span><a name="line-35"></a><span>    </span><a href="APEG.State.html#valEnv"><span class="hs-identifier hs-var">valEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-36"></a><span>    </span><a href="APEG.State.html#tyEnv"><span class="hs-identifier hs-var">tyEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-37"></a><span>    </span><a href="APEG.State.html#upValEnv"><span class="hs-identifier hs-var">upValEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-38"></a><span>    </span><a href="APEG.State.html#upTyEnv"><span class="hs-identifier hs-var">upTyEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-39"></a><span>    </span><a href="APEG.State.html#withResult"><span class="hs-identifier hs-var">withResult</span></a><span class="hs-special">,</span><span>
</span><a name="line-40"></a><span>
</span><a name="line-41"></a><span>    </span><a href="APEG.State.html#valIsMExpr"><span class="hs-identifier hs-var">valIsMExpr</span></a><span class="hs-special">,</span><span>
</span><a name="line-42"></a><span>    </span><a href="APEG.State.html#valIsMPeg"><span class="hs-identifier hs-var">valIsMPeg</span></a><span class="hs-special">,</span><span>
</span><a name="line-43"></a><span>    </span><a href="APEG.State.html#strVal"><span class="hs-identifier hs-var">strVal</span></a><span class="hs-special">,</span><span>
</span><a name="line-44"></a><span>    </span><a href="APEG.State.html#expFromVal"><span class="hs-identifier hs-var">expFromVal</span></a><span class="hs-special">,</span><span>
</span><a name="line-45"></a><span>    </span><a href="APEG.State.html#varNameFromVal"><span class="hs-identifier hs-var">varNameFromVal</span></a><span class="hs-special">,</span><span>
</span><a name="line-46"></a><span>    </span><a href="APEG.State.html#apegFromVal"><span class="hs-identifier hs-var">apegFromVal</span></a><span class="hs-special">,</span><span>
</span><a name="line-47"></a><span>
</span><a name="line-48"></a><span>    </span><a href="APEG.State.html#zeroSt"><span class="hs-identifier hs-var">zeroSt</span></a><span class="hs-special">,</span><span>
</span><a name="line-49"></a><span>    </span><a href="APEG.State.html#ruleEntry"><span class="hs-identifier hs-var">ruleEntry</span></a><span class="hs-special">,</span><span>
</span><a name="line-50"></a><span>
</span><a name="line-51"></a><span>    </span><a href="APEG.State.html#isOk"><span class="hs-identifier hs-var">isOk</span></a><span>
</span><a name="line-52"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-53"></a><span>
</span><a name="line-54"></a><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><a href="APEG.AbstractSyntax.html"><span class="hs-identifier">APEG.AbstractSyntax</span></a><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Map</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">M</span><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.State.Lazy</span><span>
</span><a name="line-58"></a><span>
</span><a name="line-59"></a><span class="hs-comment">-- | Value environment, a mapping form names to 'Values'</span><span>
</span><a name="line-60"></a><span class="hs-keyword">type</span><span> </span><a name="VEnv"><a href="APEG.State.html#VEnv"><span class="hs-identifier">VEnv</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">M.Map</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><a href="APEG.AbstractSyntax.html#Value"><span class="hs-identifier hs-type">Value</span></a><span>
</span><a name="line-61"></a><span>
</span><a name="line-62"></a><span class="hs-comment">-- | Type environment, a mapping from names to a non terminal 'Type' an </span><span>
</span><a name="line-63"></a><span class="hs-comment">-- it's inner enviroment</span><span>
</span><a name="line-64"></a><span class="hs-keyword">type</span><span> </span><a name="TyEnv"><a href="APEG.State.html#TyEnv"><span class="hs-identifier">TyEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">M.Map</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-special">(</span><a href="APEG.AbstractSyntax.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-special">,</span><span> </span><a href="APEG.State.html#TyRuleEnv"><span class="hs-identifier hs-type">TyRuleEnv</span></a><span class="hs-special">)</span><span>
</span><a name="line-65"></a><span>
</span><a name="line-66"></a><span class="hs-comment">-- | Type environment for a rule. Maps varialble names to </span><span>
</span><a name="line-67"></a><span class="hs-keyword">type</span><span> </span><a name="TyRuleEnv"><a href="APEG.State.html#TyRuleEnv"><span class="hs-identifier">TyRuleEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">M.Map</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><a href="APEG.AbstractSyntax.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>
</span><a name="line-68"></a><span>
</span><a name="line-69"></a><span class="hs-comment">-- | The recognizer input is represented by an String.</span><span>
</span><a name="line-70"></a><span class="hs-keyword">type</span><span> </span><a name="Input"><a href="APEG.State.html#Input"><span class="hs-identifier">Input</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-71"></a><span>
</span><a name="line-72"></a><span class="hs-comment">-- | The result buit by a parser. Can either be an list of error messages or</span><span>
</span><a name="line-73"></a><span class="hs-comment">-- an actual value of some type a.</span><span>
</span><a name="line-74"></a><span class="hs-keyword">type</span><span> </span><a name="Result"><a href="APEG.State.html#Result"><span class="hs-identifier">Result</span></a></a><span> </span><a name="local-6989586621679027815"><a href="#local-6989586621679027815"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621679027815"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-75"></a><span>
</span><a name="line-76"></a><span class="hs-comment">-- | A TraceStr is a String that may be initialized, an actual string, or may not be initialized,</span><span>
</span><a name="line-77"></a><span class="hs-comment">-- a null String. Any operation on null String will result a null String. This definition is for the </span><span>
</span><a name="line-78"></a><span class="hs-comment">-- sake of memory usage on the APEG bind operation, that migth require toe keep the whole input </span><span>
</span><a name="line-79"></a><span class="hs-comment">-- as the recognized input. </span><span>
</span><a name="line-80"></a><span class="hs-keyword">type</span><span> </span><a name="TraceStr"><a href="APEG.State.html#TraceStr"><span class="hs-identifier">TraceStr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-81"></a><span>
</span><a name="line-82"></a><span>
</span><a name="line-83"></a><span class="hs-keyword">type</span><span> </span><a name="APegTuple"><a href="APEG.State.html#APegTuple"><span class="hs-identifier">APegTuple</span></a></a><span> </span><a name="local-6989586621679027814"><a href="#local-6989586621679027814"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-84"></a><span>                   </span><span class="hs-special">(</span><a href="APEG.State.html#VEnv"><span class="hs-identifier hs-type">VEnv</span></a><span class="hs-special">,</span><span>      </span><span class="hs-comment">--  An envoironment of values  </span><span>
</span><a name="line-85"></a><span>                    </span><a href="APEG.State.html#TyEnv"><span class="hs-identifier hs-type">TyEnv</span></a><span class="hs-special">,</span><span>     </span><span class="hs-comment">--  A type enviroment for a rule and it's local variables. </span><span>
</span><a name="line-86"></a><span>                    </span><a href="APEG.State.html#TraceStr"><span class="hs-identifier hs-type">TraceStr</span></a><span class="hs-special">,</span><span>  </span><span class="hs-comment">--  The current string accept by current rule. It may be a null String.</span><span>
</span><a name="line-87"></a><span>                    </span><a href="APEG.State.html#Input"><span class="hs-identifier hs-type">Input</span></a><span class="hs-special">,</span><span>     </span><span class="hs-comment">--  The current input text. </span><span>
</span><a name="line-88"></a><span>                    </span><a href="APEG.State.html#Result"><span class="hs-identifier hs-type">Result</span></a><span> </span><a href="#local-6989586621679027814"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">--  The Result of last operation. It may contain a value.</span><span>
</span><a name="line-89"></a><span>
</span><a name="line-90"></a><span class="hs-keyword">type</span><span> </span><a name="SmallTuple"><a href="APEG.State.html#SmallTuple"><span class="hs-identifier">SmallTuple</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="APEG.State.html#VEnv"><span class="hs-identifier hs-type">VEnv</span></a><span class="hs-special">,</span><span>    </span><span class="hs-comment">--  A stack of value enviroments   </span><span>
</span><a name="line-91"></a><span>                   </span><span class="hs-identifier hs-type">String</span><span class="hs-special">,</span><span>  </span><span class="hs-comment">--  the current string accept by the parser on the current rule.</span><span>
</span><a name="line-92"></a><span>                   </span><a href="APEG.State.html#Input"><span class="hs-identifier hs-type">Input</span></a><span class="hs-special">,</span><span>   </span><span class="hs-comment">--  The current input state. </span><span>
</span><a name="line-93"></a><span>                   </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span>    </span><span class="hs-comment">--  The Result of las operation</span><span>
</span><a name="line-94"></a><span>
</span><a name="line-95"></a><span class="hs-comment">-- State for the APEG interpreter: </span><span>
</span><a name="line-96"></a><span class="hs-keyword">type</span><span> </span><a name="APegSt"><a href="APEG.State.html#APegSt"><span class="hs-identifier">APegSt</span></a></a><span> </span><a name="local-6989586621679027668"><a href="#local-6989586621679027668"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">State</span><span> </span><span class="hs-special">(</span><a href="APEG.State.html#APegTuple"><span class="hs-identifier hs-type">APegTuple</span></a><span> </span><a href="#local-6989586621679027668"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-97"></a><span>
</span><a name="line-98"></a><span class="hs-comment">-- | Builds a success Result from a particular value.</span><span>
</span><a name="line-99"></a><span class="hs-identifier">rVal</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679027981"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="APEG.State.html#Result"><span class="hs-identifier hs-type">Result</span></a><span> </span><a href="#local-6989586621679027981"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-100"></a><a name="rVal"><a href="APEG.State.html#rVal"><span class="hs-identifier">rVal</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Right</span><span>
</span><a name="line-101"></a><span>
</span><a name="line-102"></a><span class="hs-comment">-- | Builds a failure Result from an error message.</span><span>
</span><a name="line-103"></a><span class="hs-identifier">rErr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="APEG.State.html#Result"><span class="hs-identifier hs-type">Result</span></a><span> </span><a href="#local-6989586621679027980"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-104"></a><a name="rErr"><a href="APEG.State.html#rErr"><span class="hs-identifier">rErr</span></a></a><span> </span><a name="local-6989586621679027982"><a href="#local-6989586621679027982"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679027982"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">]</span><span>
</span><a name="line-105"></a><span>
</span><a name="line-106"></a><span>
</span><a name="line-107"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-108"></a><span class="hs-special">(</span><span class="hs-operator">?:</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Char</span><span> </span><span class="hs-glyph">-&gt;</span><a href="APEG.State.html#TraceStr"><span class="hs-identifier hs-type">TraceStr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="APEG.State.html#TraceStr"><span class="hs-identifier hs-type">TraceStr</span></a><span>
</span><a name="line-109"></a><span class="hs-special">(</span><a name="%3F%3A"><a href="APEG.State.html#%3F%3A"><span class="hs-operator">?:</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-110"></a><span class="hs-special">(</span><span class="hs-operator">?:</span><span class="hs-special">)</span><span> </span><a name="local-6989586621679027983"><a href="#local-6989586621679027983"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679027984"><a href="#local-6989586621679027984"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679027983"><span class="hs-identifier hs-var">x</span></a><span class="hs-glyph">:</span><a href="#local-6989586621679027984"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span>
</span><a name="line-111"></a><span>
</span><a name="line-112"></a><span class="hs-special">(</span><span class="hs-operator">?++</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="APEG.State.html#TraceStr"><span class="hs-identifier hs-type">TraceStr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="APEG.State.html#TraceStr"><span class="hs-identifier hs-type">TraceStr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="APEG.State.html#TraceStr"><span class="hs-identifier hs-type">TraceStr</span></a><span>
</span><a name="line-113"></a><span class="hs-special">(</span><a name="%3F%2B%2B"><a href="APEG.State.html#%3F%2B%2B"><span class="hs-operator">?++</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a name="local-6989586621679027985"><a href="#local-6989586621679027985"><span class="hs-identifier">xs</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679027985"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-114"></a><span class="hs-special">(</span><span class="hs-operator">?++</span><span class="hs-special">)</span><span> </span><a name="local-6989586621679027986"><a href="#local-6989586621679027986"><span class="hs-identifier">ys</span></a></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679027986"><span class="hs-identifier hs-var">ys</span></a><span>
</span><a name="line-115"></a><span class="hs-special">(</span><span class="hs-operator">?++</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679027987"><a href="#local-6989586621679027987"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679027988"><a href="#local-6989586621679027988"><span class="hs-identifier">ys</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679027987"><span class="hs-identifier hs-var">xs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679027988"><span class="hs-identifier hs-var">ys</span></a><span class="hs-special">)</span><span>
</span><a name="line-116"></a><span>
</span><a name="line-117"></a><span>
</span><a name="line-118"></a><span class="hs-identifier">nullTraceStr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="APEG.State.html#TraceStr"><span class="hs-identifier hs-type">TraceStr</span></a><span>
</span><a name="line-119"></a><a name="nullTraceStr"><a href="APEG.State.html#nullTraceStr"><span class="hs-identifier">nullTraceStr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-120"></a><span>
</span><a name="line-121"></a><span class="hs-identifier">emptyTraceStr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="APEG.State.html#TraceStr"><span class="hs-identifier hs-type">TraceStr</span></a><span>
</span><a name="line-122"></a><a name="emptyTraceStr"><a href="APEG.State.html#emptyTraceStr"><span class="hs-identifier">emptyTraceStr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-123"></a><span>
</span><a name="line-124"></a><span class="hs-identifier">errorTuple</span><span> </span><span class="hs-glyph">::</span><span>  </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="APEG.State.html#APegTuple"><span class="hs-identifier hs-type">APegTuple</span></a><span> </span><a href="#local-6989586621679027979"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>  </span><a href="APEG.State.html#APegTuple"><span class="hs-identifier hs-type">APegTuple</span></a><span> </span><a href="#local-6989586621679027979"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-125"></a><a name="errorTuple"><a href="APEG.State.html#errorTuple"><span class="hs-identifier">errorTuple</span></a></a><span> </span><a name="local-6989586621679027989"><a href="#local-6989586621679027989"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679027990"><a href="#local-6989586621679027990"><span class="hs-identifier">ve</span></a></a><span class="hs-special">,</span><a name="local-6989586621679027991"><a href="#local-6989586621679027991"><span class="hs-identifier">te</span></a></a><span class="hs-special">,</span><a name="local-6989586621679027992"><a href="#local-6989586621679027992"><span class="hs-identifier">rec</span></a></a><span class="hs-special">,</span><a name="local-6989586621679027993"><a href="#local-6989586621679027993"><span class="hs-identifier">inp</span></a></a><span class="hs-special">,</span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679027994"><a href="#local-6989586621679027994"><span class="hs-identifier">m</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>  </span><span class="hs-special">(</span><a href="#local-6989586621679027990"><span class="hs-identifier hs-var">ve</span></a><span class="hs-special">,</span><a href="#local-6989586621679027991"><span class="hs-identifier hs-var">te</span></a><span class="hs-special">,</span><a href="#local-6989586621679027992"><span class="hs-identifier hs-var">rec</span></a><span class="hs-special">,</span><a href="#local-6989586621679027993"><span class="hs-identifier hs-var">inp</span></a><span class="hs-special">,</span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679027989"><span class="hs-identifier hs-var">s</span></a><span class="hs-glyph">:</span><a href="#local-6989586621679027994"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-126"></a><span class="hs-identifier">errorTuple</span><span> </span><a name="local-6989586621679027995"><a href="#local-6989586621679027995"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679027996"><a href="#local-6989586621679027996"><span class="hs-identifier">ve</span></a></a><span class="hs-special">,</span><a name="local-6989586621679027997"><a href="#local-6989586621679027997"><span class="hs-identifier">te</span></a></a><span class="hs-special">,</span><a name="local-6989586621679027998"><a href="#local-6989586621679027998"><span class="hs-identifier">rec</span></a></a><span class="hs-special">,</span><a name="local-6989586621679027999"><a href="#local-6989586621679027999"><span class="hs-identifier">inp</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>  </span><span class="hs-special">(</span><a href="#local-6989586621679027996"><span class="hs-identifier hs-var">ve</span></a><span class="hs-special">,</span><a href="#local-6989586621679027997"><span class="hs-identifier hs-var">te</span></a><span class="hs-special">,</span><a href="#local-6989586621679027998"><span class="hs-identifier hs-var">rec</span></a><span class="hs-special">,</span><a href="#local-6989586621679027999"><span class="hs-identifier hs-var">inp</span></a><span class="hs-special">,</span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679027995"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-127"></a><span>
</span><a name="line-128"></a><span class="hs-identifier">isOkTuple</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="APEG.State.html#APegTuple"><span class="hs-identifier hs-type">APegTuple</span></a><span> </span><a href="#local-6989586621679027978"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-129"></a><a name="isOkTuple"><a href="APEG.State.html#isOkTuple"><span class="hs-identifier">isOkTuple</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679028000"><a href="#local-6989586621679028000"><span class="hs-identifier">ve</span></a></a><span class="hs-special">,</span><a name="local-6989586621679028001"><a href="#local-6989586621679028001"><span class="hs-identifier">te</span></a></a><span class="hs-special">,</span><a name="local-6989586621679028002"><a href="#local-6989586621679028002"><span class="hs-identifier">rec</span></a></a><span class="hs-special">,</span><a name="local-6989586621679028003"><a href="#local-6989586621679028003"><span class="hs-identifier">inp</span></a></a><span class="hs-special">,</span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-130"></a><span class="hs-identifier">isOkTuple</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679028004"><a href="#local-6989586621679028004"><span class="hs-identifier">ve</span></a></a><span class="hs-special">,</span><a name="local-6989586621679028005"><a href="#local-6989586621679028005"><span class="hs-identifier">te</span></a></a><span class="hs-special">,</span><a name="local-6989586621679028006"><a href="#local-6989586621679028006"><span class="hs-identifier">rec</span></a></a><span class="hs-special">,</span><a name="local-6989586621679028007"><a href="#local-6989586621679028007"><span class="hs-identifier">inp</span></a></a><span class="hs-special">,</span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-131"></a><span>
</span><a name="line-132"></a><span class="hs-identifier">valEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="APEG.State.html#APegTuple"><span class="hs-identifier hs-type">APegTuple</span></a><span> </span><a href="#local-6989586621679027977"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="APEG.State.html#VEnv"><span class="hs-identifier hs-type">VEnv</span></a><span>
</span><a name="line-133"></a><a name="valEnv"><a href="APEG.State.html#valEnv"><span class="hs-identifier">valEnv</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679028008"><a href="#local-6989586621679028008"><span class="hs-identifier">ve</span></a></a><span class="hs-special">,</span><a name="local-6989586621679028009"><a href="#local-6989586621679028009"><span class="hs-identifier">te</span></a></a><span class="hs-special">,</span><a name="local-6989586621679028010"><a href="#local-6989586621679028010"><span class="hs-identifier">rec</span></a></a><span class="hs-special">,</span><a name="local-6989586621679028011"><a href="#local-6989586621679028011"><span class="hs-identifier">inp</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679028008"><span class="hs-identifier hs-var">ve</span></a><span>
</span><a name="line-134"></a><span>
</span><a name="line-135"></a><span class="hs-identifier">tyEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="APEG.State.html#APegTuple"><span class="hs-identifier hs-type">APegTuple</span></a><span> </span><a href="#local-6989586621679027976"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="APEG.State.html#TyEnv"><span class="hs-identifier hs-type">TyEnv</span></a><span>
</span><a name="line-136"></a><a name="tyEnv"><a href="APEG.State.html#tyEnv"><span class="hs-identifier">tyEnv</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679028012"><a href="#local-6989586621679028012"><span class="hs-identifier">ve</span></a></a><span class="hs-special">,</span><a name="local-6989586621679028013"><a href="#local-6989586621679028013"><span class="hs-identifier">te</span></a></a><span class="hs-special">,</span><a name="local-6989586621679028014"><a href="#local-6989586621679028014"><span class="hs-identifier">rec</span></a></a><span class="hs-special">,</span><a name="local-6989586621679028015"><a href="#local-6989586621679028015"><span class="hs-identifier">inp</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679028013"><span class="hs-identifier hs-var">te</span></a><span>
</span><a name="line-137"></a><span>
</span><a name="line-138"></a><span class="hs-identifier">upValEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="APEG.State.html#VEnv"><span class="hs-identifier hs-type">VEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="APEG.State.html#VEnv"><span class="hs-identifier hs-type">VEnv</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="APEG.State.html#APegTuple"><span class="hs-identifier hs-type">APegTuple</span></a><span> </span><a href="#local-6989586621679027975"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="APEG.State.html#APegTuple"><span class="hs-identifier hs-type">APegTuple</span></a><span> </span><a href="#local-6989586621679027975"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-139"></a><a name="upValEnv"><a href="APEG.State.html#upValEnv"><span class="hs-identifier">upValEnv</span></a></a><span> </span><a name="local-6989586621679028016"><a href="#local-6989586621679028016"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679028017"><a href="#local-6989586621679028017"><span class="hs-identifier">ve</span></a></a><span class="hs-special">,</span><a name="local-6989586621679028018"><a href="#local-6989586621679028018"><span class="hs-identifier">te</span></a></a><span class="hs-special">,</span><a name="local-6989586621679028019"><a href="#local-6989586621679028019"><span class="hs-identifier">rec</span></a></a><span class="hs-special">,</span><a name="local-6989586621679028020"><a href="#local-6989586621679028020"><span class="hs-identifier">inp</span></a></a><span class="hs-special">,</span><a name="local-6989586621679028021"><a href="#local-6989586621679028021"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679028016"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679028017"><span class="hs-identifier hs-var">ve</span></a><span class="hs-special">,</span><a href="#local-6989586621679028018"><span class="hs-identifier hs-var">te</span></a><span class="hs-special">,</span><a href="#local-6989586621679028019"><span class="hs-identifier hs-var">rec</span></a><span class="hs-special">,</span><a href="#local-6989586621679028020"><span class="hs-identifier hs-var">inp</span></a><span class="hs-special">,</span><a href="#local-6989586621679028021"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-140"></a><span>
</span><a name="line-141"></a><span class="hs-identifier">upTyEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="APEG.State.html#TyEnv"><span class="hs-identifier hs-type">TyEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="APEG.State.html#TyEnv"><span class="hs-identifier hs-type">TyEnv</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="APEG.State.html#APegTuple"><span class="hs-identifier hs-type">APegTuple</span></a><span> </span><a href="#local-6989586621679027974"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="APEG.State.html#APegTuple"><span class="hs-identifier hs-type">APegTuple</span></a><span> </span><a href="#local-6989586621679027974"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-142"></a><a name="upTyEnv"><a href="APEG.State.html#upTyEnv"><span class="hs-identifier">upTyEnv</span></a></a><span> </span><a name="local-6989586621679028022"><a href="#local-6989586621679028022"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679028023"><a href="#local-6989586621679028023"><span class="hs-identifier">ve</span></a></a><span class="hs-special">,</span><a name="local-6989586621679028024"><a href="#local-6989586621679028024"><span class="hs-identifier">te</span></a></a><span class="hs-special">,</span><a name="local-6989586621679028025"><a href="#local-6989586621679028025"><span class="hs-identifier">rec</span></a></a><span class="hs-special">,</span><a name="local-6989586621679028026"><a href="#local-6989586621679028026"><span class="hs-identifier">inp</span></a></a><span class="hs-special">,</span><a name="local-6989586621679028027"><a href="#local-6989586621679028027"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679028023"><span class="hs-identifier hs-var">ve</span></a><span class="hs-special">,</span><a href="#local-6989586621679028022"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679028024"><span class="hs-identifier hs-var">te</span></a><span class="hs-special">,</span><a href="#local-6989586621679028025"><span class="hs-identifier hs-var">rec</span></a><span class="hs-special">,</span><a href="#local-6989586621679028026"><span class="hs-identifier hs-var">inp</span></a><span class="hs-special">,</span><a href="#local-6989586621679028027"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-143"></a><span>
</span><a name="line-144"></a><span class="hs-identifier">withResult</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="APEG.State.html#Result"><span class="hs-identifier hs-type">Result</span></a><span> </span><a href="#local-6989586621679027972"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679027973"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="APEG.State.html#Result"><span class="hs-identifier hs-type">Result</span></a><span> </span><a href="#local-6989586621679027972"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="APEG.State.html#APegTuple"><span class="hs-identifier hs-type">APegTuple</span></a><span> </span><a href="#local-6989586621679027973"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="APEG.State.html#APegTuple"><span class="hs-identifier hs-type">APegTuple</span></a><span> </span><a href="#local-6989586621679027972"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-145"></a><a name="withResult"><a href="APEG.State.html#withResult"><span class="hs-identifier">withResult</span></a></a><span> </span><a name="local-6989586621679028028"><a href="#local-6989586621679028028"><span class="hs-identifier">err</span></a></a><span> </span><a name="local-6989586621679028029"><a href="#local-6989586621679028029"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679028030"><a href="#local-6989586621679028030"><span class="hs-identifier">ve</span></a></a><span class="hs-special">,</span><a name="local-6989586621679028031"><a href="#local-6989586621679028031"><span class="hs-identifier">te</span></a></a><span class="hs-special">,</span><a name="local-6989586621679028032"><a href="#local-6989586621679028032"><span class="hs-identifier">rec</span></a></a><span class="hs-special">,</span><a name="local-6989586621679028033"><a href="#local-6989586621679028033"><span class="hs-identifier">inp</span></a></a><span class="hs-special">,</span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679028034"><a href="#local-6989586621679028034"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679028030"><span class="hs-identifier hs-var">ve</span></a><span class="hs-special">,</span><a href="#local-6989586621679028031"><span class="hs-identifier hs-var">te</span></a><span class="hs-special">,</span><a href="#local-6989586621679028032"><span class="hs-identifier hs-var">rec</span></a><span class="hs-special">,</span><a href="#local-6989586621679028033"><span class="hs-identifier hs-var">inp</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679028028"><span class="hs-identifier hs-var">err</span></a><span> </span><a href="#local-6989586621679028034"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-146"></a><span class="hs-identifier">withResult</span><span> </span><a name="local-6989586621679028035"><a href="#local-6989586621679028035"><span class="hs-identifier">err</span></a></a><span> </span><a name="local-6989586621679028036"><a href="#local-6989586621679028036"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679028037"><a href="#local-6989586621679028037"><span class="hs-identifier">ve</span></a></a><span class="hs-special">,</span><a name="local-6989586621679028038"><a href="#local-6989586621679028038"><span class="hs-identifier">te</span></a></a><span class="hs-special">,</span><a name="local-6989586621679028039"><a href="#local-6989586621679028039"><span class="hs-identifier">rec</span></a></a><span class="hs-special">,</span><a name="local-6989586621679028040"><a href="#local-6989586621679028040"><span class="hs-identifier">inp</span></a></a><span class="hs-special">,</span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679028041"><a href="#local-6989586621679028041"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679028037"><span class="hs-identifier hs-var">ve</span></a><span class="hs-special">,</span><a href="#local-6989586621679028038"><span class="hs-identifier hs-var">te</span></a><span class="hs-special">,</span><a href="#local-6989586621679028039"><span class="hs-identifier hs-var">rec</span></a><span class="hs-special">,</span><a href="#local-6989586621679028040"><span class="hs-identifier hs-var">inp</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679028036"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679028041"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-147"></a><span>
</span><a name="line-148"></a><span>
</span><a name="line-149"></a><span class="hs-identifier">valIsMExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="APEG.AbstractSyntax.html#Value"><span class="hs-identifier hs-type">Value</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-150"></a><a name="valIsMExpr"><a href="APEG.State.html#valIsMExpr"><span class="hs-identifier">valIsMExpr</span></a></a><span> </span><span class="hs-special">(</span><a href="APEG.AbstractSyntax.html#VExp"><span class="hs-identifier hs-var">VExp</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-151"></a><span class="hs-identifier">valIsMExpr</span><span> </span><span class="hs-identifier">_</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-152"></a><span>
</span><a name="line-153"></a><span class="hs-identifier">valIsMPeg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="APEG.AbstractSyntax.html#Value"><span class="hs-identifier hs-type">Value</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-154"></a><a name="valIsMPeg"><a href="APEG.State.html#valIsMPeg"><span class="hs-identifier">valIsMPeg</span></a></a><span> </span><span class="hs-special">(</span><a href="APEG.AbstractSyntax.html#VPeg"><span class="hs-identifier hs-var">VPeg</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-155"></a><span class="hs-identifier">valIsMPeg</span><span> </span><span class="hs-identifier">_</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-156"></a><span>
</span><a name="line-157"></a><span class="hs-identifier">strVal</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="APEG.AbstractSyntax.html#Value"><span class="hs-identifier hs-type">Value</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-158"></a><a name="strVal"><a href="APEG.State.html#strVal"><span class="hs-identifier">strVal</span></a></a><span> </span><span class="hs-special">(</span><a href="APEG.AbstractSyntax.html#VStr"><span class="hs-identifier hs-var">VStr</span></a><span> </span><a name="local-6989586621679028042"><a href="#local-6989586621679028042"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679028042"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-159"></a><span>
</span><a name="line-160"></a><span class="hs-identifier">expFromVal</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="APEG.AbstractSyntax.html#Value"><span class="hs-identifier hs-type">Value</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="APEG.AbstractSyntax.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span>
</span><a name="line-161"></a><a name="expFromVal"><a href="APEG.State.html#expFromVal"><span class="hs-identifier">expFromVal</span></a></a><span> </span><span class="hs-special">(</span><a href="APEG.AbstractSyntax.html#VExp"><span class="hs-identifier hs-var">VExp</span></a><span> </span><a name="local-6989586621679028043"><a href="#local-6989586621679028043"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679028043"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-162"></a><span>
</span><a name="line-163"></a><span class="hs-identifier">varNameFromVal</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="APEG.AbstractSyntax.html#Value"><span class="hs-identifier hs-type">Value</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="APEG.AbstractSyntax.html#Var"><span class="hs-identifier hs-type">Var</span></a><span>
</span><a name="line-164"></a><a name="varNameFromVal"><a href="APEG.State.html#varNameFromVal"><span class="hs-identifier">varNameFromVal</span></a></a><span> </span><span class="hs-special">(</span><a href="APEG.AbstractSyntax.html#VExp"><span class="hs-identifier hs-var">VExp</span></a><span> </span><span class="hs-special">(</span><a href="APEG.AbstractSyntax.html#Str"><span class="hs-identifier hs-var">Str</span></a><span> </span><a name="local-6989586621679028044"><a href="#local-6989586621679028044"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679028044"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-165"></a><span>
</span><a name="line-166"></a><span class="hs-identifier">apegFromVal</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="APEG.AbstractSyntax.html#Value"><span class="hs-identifier hs-type">Value</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="APEG.AbstractSyntax.html#APeg"><span class="hs-identifier hs-type">APeg</span></a><span>
</span><a name="line-167"></a><a name="apegFromVal"><a href="APEG.State.html#apegFromVal"><span class="hs-identifier">apegFromVal</span></a></a><span> </span><span class="hs-special">(</span><a href="APEG.AbstractSyntax.html#VPeg"><span class="hs-identifier hs-var">VPeg</span></a><span> </span><a name="local-6989586621679028045"><a href="#local-6989586621679028045"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679028045"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-168"></a><span>
</span><a name="line-169"></a><span>
</span><a name="line-170"></a><span class="hs-identifier">zeroSt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="APEG.AbstractSyntax.html#ApegGrm"><span class="hs-identifier hs-type">ApegGrm</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="APEG.State.html#APegTuple"><span class="hs-identifier hs-type">APegTuple</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-171"></a><a name="zeroSt"><a href="APEG.State.html#zeroSt"><span class="hs-identifier">zeroSt</span></a></a><span> </span><a name="local-6989586621679028046"><a href="#local-6989586621679028046"><span class="hs-identifier">grm</span></a></a><span> </span><a name="local-6989586621679028047"><a href="#local-6989586621679028047"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">M.fromList</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-string">&quot;g&quot;</span><span class="hs-special">,</span><a href="APEG.AbstractSyntax.html#VLan"><span class="hs-identifier hs-var">VLan</span></a><span> </span><a href="#local-6989586621679028046"><span class="hs-identifier hs-var">grm</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">M.fromList</span><span> </span><a href="#local-6989586621679028048"><span class="hs-identifier hs-var">zs</span></a><span class="hs-special">,</span><span> </span><a href="APEG.State.html#nullTraceStr"><span class="hs-identifier hs-var">nullTraceStr</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679028047"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-172"></a><span>    </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679028048"><a href="#local-6989586621679028048"><span class="hs-identifier">zs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="APEG.State.html#ruleEntry"><span class="hs-identifier hs-var">ruleEntry</span></a><span> </span><a href="#local-6989586621679028046"><span class="hs-identifier hs-var">grm</span></a><span>
</span><a name="line-173"></a><span>
</span><a name="line-174"></a><span>
</span><a name="line-175"></a><span class="hs-identifier">ruleEntry</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="APEG.AbstractSyntax.html#ApegRule"><span class="hs-identifier hs-type">ApegRule</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="APEG.AbstractSyntax.html#NonTerminal"><span class="hs-identifier hs-type">NonTerminal</span></a><span class="hs-special">,</span><span class="hs-special">(</span><a href="APEG.AbstractSyntax.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">,</span><span> </span><a href="APEG.State.html#TyRuleEnv"><span class="hs-identifier hs-type">TyRuleEnv</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-176"></a><a name="ruleEntry"><a href="APEG.State.html#ruleEntry"><span class="hs-identifier">ruleEntry</span></a></a><span> </span><span class="hs-special">(</span><a href="APEG.AbstractSyntax.html#ApegRule"><span class="hs-identifier hs-var">ApegRule</span></a><span> </span><a name="local-6989586621679028049"><a href="#local-6989586621679028049"><span class="hs-identifier">nt</span></a></a><span> </span><a name="local-6989586621679028050"><a href="#local-6989586621679028050"><span class="hs-identifier">inh</span></a></a><span> </span><a name="local-6989586621679028051"><a href="#local-6989586621679028051"><span class="hs-identifier">syn</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679028049"><span class="hs-identifier hs-var">nt</span></a><span class="hs-special">,</span><span class="hs-special">(</span><a href="APEG.AbstractSyntax.html#TyRule"><span class="hs-identifier hs-var">TyRule</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621679028050"><span class="hs-identifier hs-var">inh</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621679028051"><span class="hs-identifier hs-var">syn</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span class="hs-identifier hs-var">M.fromList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679028068"><a href="#local-6989586621679028068"><span class="hs-identifier">a</span></a></a><span class="hs-special">,</span><a name="local-6989586621679028069"><a href="#local-6989586621679028069"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679028069"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">,</span><a href="#local-6989586621679028068"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679028050"><span class="hs-identifier hs-var">inh</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-177"></a><span>
</span><a name="line-178"></a><span>
</span><a name="line-179"></a><span>
</span><a name="line-180"></a><span class="hs-identifier">isOk</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="APEG.State.html#APegSt"><span class="hs-identifier hs-type">APegSt</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-181"></a><a name="isOk"><a href="APEG.State.html#isOk"><span class="hs-identifier">isOk</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">get</span><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-identifier hs-var">return</span><span class="hs-operator hs-var">.</span><a href="APEG.State.html#isOkTuple"><span class="hs-identifier hs-var">isOkTuple</span></a><span>
</span><a name="line-182"></a><span>
</span><a name="line-183"></a><span class="hs-comment">{-

matchAll :: [Type] -&gt; [Type] -&gt; Bool
matchAll xs ys = (and $ zipWith (==) xs ys) &amp;&amp; ((length xs) == (length ys))



tyEnvFromRule :: ApegRule -&gt; TyEnv
tyEnvFromRule r = M.fromList [ruleEntry r]

-- Projections anv Value Manipulation

language :: APegSt (ApegGrm)
language = get &gt;&gt;= \(grm,env,tyEnv,reckon,inp,res) -&gt; return grm

langExt :: ApegGrm -&gt; APegSt ()
langExt grm 
     = do g  &lt;- language
          g' &lt;- joinRules g grm
          modify (\(grm,env,tyEnv,reckon,inp,res) -&gt; (g',env,tyEnv,reckon,inp, res))
          
joinRules ::  ApegGrm -&gt; ApegGrm -&gt; APegSt ApegGrm
joinRules g []= return g
joinRules g (x:xs) = grmAddRule g x &gt;&gt;= \r -&gt; joinRules r xs

var :: String -&gt; APegSt Value
var s = get &gt;&gt;= (\(grm,env,tyEnv,reckon,inp,res) -&gt; case env M.!? s of 
                                                      Nothing -&gt; fail (&quot;Undefined varibale &quot; ++ s ++
                                                                       &quot; remaining input = &quot; ++ inp)
                                                      Just v   -&gt; return v)

varSet :: String -&gt; Value -&gt; APegSt ()
varSet s v =  envAlter (M.insert s v)

varsSet :: [(String,Value)] -&gt; APegSt ()
varsSet zs = envAlter (M.union (M.fromList zs))


grmAddRule :: ApegGrm -&gt; ApegRule -&gt; APegSt ApegGrm
grmAddRule [] r = return $ [r]
grmAddRule (x@(ApegRule nt inh syn body):xs) r@(ApegRule nt' inh' syn' body')
    | (nt == nt') &amp;&amp; (inh == inh') &amp;&amp; (syn == syn') = return $ ApegRule nt inh syn (mkAltBody body body'):xs
    | (nt == nt') &amp;&amp; ((inh /= inh') || (syn /= syn')) = fail (&quot;Conflicting definitions of &quot; ++ nt ++ &quot; when composing languages.&quot;)
    | (nt /= nt') = grmAddRule xs r &gt;&gt;= return.(x:)

envAlter :: (VEnv -&gt; VEnv) -&gt; APegSt ()
envAlter t = get &gt;&gt;= (\(grm,env,tyEnv,reckon,inp,res) -&gt; put (grm,t env,tyEnv,reckon,inp,res)) 

tyEnv :: APegSt (TyEnv)
tyEnv =  get &gt;&gt;= (\(grm,env,tyEnv,reckon,inp,res) -&gt; return tyEnv)

tyEnvAlter :: (TyEnv -&gt; TyEnv) -&gt; APegSt ()
tyEnvAlter f = modify (\(grm,env,tyEnv,reckon,inp,res) -&gt; (grm,env,f tyEnv,reckon,inp,res))

tyRuleAlter :: (TyRuleEnv -&gt; TyRuleEnv) -&gt; NonTerminal -&gt; APegSt ()
tyRuleAlter f nt = modify (\(grm,env,tyEnv,reckon,inp,res) -&gt; (grm,env,adapter tyEnv,reckon,inp,res))
    where adapter = M.adjust (\(t,renv) -&gt; (t,f renv)) nt

ntType :: NonTerminal -&gt; APegSt (Maybe Type)
ntType nt = do (_,_,tyEnv,_,_,_) &lt;- get
               case  (tyEnv M.!? nt) of
                    Just (t,_) -&gt; return $ Just t
                    Nothing    -&gt; return $ Nothing

ruleEnv :: NonTerminal -&gt; APegSt (Maybe (Type,TyRuleEnv))
ruleEnv nt = do (_,_,tyEnv,_,_,_) &lt;- get
                case  (tyEnv M.!? nt) of
                   Just t -&gt; return $ Just t
                   Nothing    -&gt; return $ Nothing

recordNtType :: NonTerminal -&gt; [(String,Type)] -&gt; [Type] -&gt; APegSt ()
recordNtType nt xs ys = tyEnvAlter (M.insert nt (TyRule (map snd xs) ys, M.fromList xs))


varTypeOn :: NonTerminal -&gt; Var -&gt; APegSt (Maybe Type)
varTypeOn nt v = do (_,_,tyEnv,_,_,_) &lt;- get
                    case  (tyEnv M.!? nt) of
                       Just (_,env) -&gt; return $ env M.!? v 
                       Nothing    -&gt; return $ Nothing

recordVarOn :: NonTerminal -&gt; Var -&gt; Type -&gt; APegSt ()
recordVarOn nt v t = tyRuleAlter (M.insert v t) nt

recordVars :: NonTerminal -&gt; [(Var, Type)] -&gt; APegSt ()
recordVars nt xs = tyRuleAlter (M.union (M.fromList xs)) nt

envSwap :: VEnv -&gt;  APegSt (VEnv) 
envSwap newEnv = do (g,env,tyEnv,reckon,inp,res) &lt;- get
                    put(g,newEnv,tyEnv,reckon,inp,res) 
                    return env
                    
tyEnvSwap :: TyEnv -&gt;  APegSt (TyEnv) 
tyEnvSwap newEnv = do (g,env,tyEnv,reckon,inp,res) &lt;- get
                      put(g,env,newEnv,reckon,inp,res) 
                      return tyEnv
                                        
                    
getStr :: APegSt (String) 
getStr = do (g,env,tyEnv,reckon,inp,res) &lt;- get
            return reckon

resetStr :: APegSt () 
resetStr = modify (\(grm,env,tyEnv,reckon,inp,res) -&gt; (grm,env,tyEnv,[],inp,res))
                     


supresEnv :: VEnv -&gt; APegSt a -&gt; APegSt a
supresEnv nwEnv b = do oldEnv &lt;- envSwap nwEnv
                       r &lt;- b
                       envSwap oldEnv
                       return r

envFromDec :: [(Type,Var)] -&gt; [Value] -&gt; VEnv
envFromDec xs vs = M.fromList $ zipWith (\(_,v) o -&gt; (v,o)) xs vs

tyEnvFromDec :: [(Type,Var)] -&gt; TyRuleEnv
tyEnvFromDec = (M.fromList).(map (\(a,b)-&gt;(b,a)))


supresTyEnv :: TyEnv -&gt; APegSt a -&gt; APegSt a
supresTyEnv nwEnv b = do oldEnv &lt;- tyEnvSwap nwEnv
                         r &lt;- b
                         tyEnvSwap oldEnv
                         return r-}</span><span>
</span><a name="line-307"></a></pre></body></html>